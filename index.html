<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- KaTeX for beautiful math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMeaYqaGwsbXcNfURiIoDRFUbIOxgAECSbCwnBidLQXe7Aa4I" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGohHnVCMCiHG" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A0A0A;
            color: #E0E0E0;
        }
        .code-editor, .code-segment pre, #modal-content-area {
            font-family: 'JetBrains Mono', monospace;
            background-color: #1A1A1A;
            color: #D4D4D4;
        }
        .explanation-panel, #modal-content {
            background-color: #121212;
            border: 1px solid #333;
            border-radius: 0.75rem;
        }
        .explanation-segment p, .explanation-segment ul, #modal-content-area p, #modal-content-area ul, #modal-content-area li {
            line-height: 1.7;
            color: #A0A0A0;
            margin-bottom: 1rem;
        }
         .explanation-segment h3, #modal-content-area h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #E0E0E0;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #333;
        }
        .explanation-segment code, #modal-content-area code {
            background-color: #2a2a2a;
            color: #F0A070;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1A1A1A; }
        ::-webkit-scrollbar-thumb { background: #4A4A4A; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5A5A5A; }
        
        .segment-row { border-top: 1px solid #333; }
        #explanation-content > .segment-row:first-child { border-top: none; }
        .explanation-segment, .code-segment { padding: 1.5rem; min-height: 50px; }
        .code-segment { border-left: 1px solid #333; background-color: #0D0D0D; }
        .code-segment pre { white-space: pre-wrap; word-wrap: break-word; padding: 0; background-color: transparent; }
        
        #notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #notification.show { opacity: 1; visibility: visible; }
        #notification.error { background-color: #e74c3c; }

        #modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 40; backdrop-filter: blur(4px); }
        #modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; max-height: 80vh; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8">
    <div id="notification" class="error"></div>

    <!-- Modal for additional features -->
    <div id="modal-overlay" class="hidden">
        <div id="modal" class="w-full max-w-3xl flex flex-col">
            <div id="modal-header" class="flex justify-between items-center p-4 bg-[#1a1a1a] rounded-t-lg border-b border-[#333]">
                <h2 id="modal-title" class="text-xl font-semibold text-white"></h2>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="modal-content-area" class="p-6 overflow-y-auto">
                <!-- AI content will be injected here -->
            </div>
        </div>
    </div>

    <header class="text-center mb-4">
        <h1 class="text-3xl md:text-4xl font-bold text-white">AI Code Assistant</h1>
        <p class="text-gray-400 mt-2">Explain, improve, and document your code with AI.</p>
    </header>

    <div class="flex justify-center mb-6 items-start gap-4">
        <div class="w-full max-w-sm">
            <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key</label>
            <input type="password" id="api-key-input" class="w-full px-3 py-2 bg-[#1A1A1A] border border-[#333] rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your API key here...">
        </div>
         <div class="w-full max-w-xs">
             <label for="model-select" class="block text-sm font-medium text-gray-300 mb-2">Select Model</label>
             <select id="model-select" class="w-full px-3 py-2 bg-[#1A1A1A] border border-[#333] rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="gemini-2.5-flash-lite" selected>Gemini 2.5 Flash-Lite</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash-Lite</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
             </select>
        </div>
    </div>

    <main class="flex-grow w-full max-w-7xl mx-auto flex flex-col">
         <div class="flex flex-col md:flex-row items-center justify-between mb-4 gap-4">
            <div class="flex-grow w-full">
                <h2 class="text-xl font-semibold text-white">Your Code</h2>
                 <p class="text-sm text-gray-400">Upload or paste your code below to begin.</p>
            </div>
            <div class="flex items-center gap-4 flex-wrap justify-center">
                <label for="file-upload" class="btn cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-blue-700">
                    Upload File
                </label>
                <input id="file-upload" type="file" class="hidden">
                <button id="improve-btn" class="btn bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-purple-700">✨ Suggest Improvements</button>
                <button id="docs-btn" class="btn bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-indigo-700">✨ Add Documentation</button>
                <button id="generate-btn" class="btn bg-green-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-green-700">Explain Code</button>
            </div>
        </div>

        <textarea id="code-input" class="code-editor w-full p-4 rounded-lg border text-sm h-64 resize-y mb-8"></textarea>
        
        <!-- Explanation Output -->
        <div id="explanation-panel" class="explanation-panel w-full rounded-lg relative overflow-hidden">
             <div id="placeholder" class="text-gray-500 text-center py-10">
                Your code explanation will appear here in a side-by-side view.
            </div>
            <div id="loader" class="hidden absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                 <p id="loader-text" class="ml-4 text-white"></p>
            </div>
            <div id="explanation-content" class="space-y-0"></div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof renderMathInElement === 'function') {
                renderMathInElement(document.body);
            }
        });

        // Main UI elements
        const fileUpload = document.getElementById('file-upload');
        const codeInput = document.getElementById('code-input');
        const generateBtn = document.getElementById('generate-btn');
        const improveBtn = document.getElementById('improve-btn');
        const docsBtn = document.getElementById('docs-btn');
        const placeholder = document.getElementById('placeholder');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const explanationContent = document.getElementById('explanation-content');
        const apiKeyInput = document.getElementById('api-key-input');
        const notification = document.getElementById('notification');
        const modelSelect = document.getElementById('model-select');
        
        // Modal elements
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalContentArea = document.getElementById('modal-content-area');
        const modalCloseBtn = document.getElementById('modal-close-btn');


        codeInput.value = `# Welcome! Paste your code here or upload a file.
# Example Python code with a formula: a^2 + b^2 = c^2

import math

class Vector:
    """Represents a 2D vector."""
    def __init__(self, x=0, y=0):
        self.x = x
        self.y = y

    def magnitude(self):
        """
        Returns the magnitude (length) of the vector.
        Calculated using the Pythagorean theorem: $M = \\sqrt{x^2 + y^2}$
        """
        return math.sqrt(self.x**2 + self.y**2)

# --- Usage Example ---
v1 = Vector(3, 4)
print(f"Magnitude of v1: {v1.magnitude()}")`;

        fileUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    codeInput.value = e.target.result;
                    explanationContent.innerHTML = '';
                    placeholder.style.display = 'block';
                };
                reader.readAsText(file);
            }
        });
        
        function showNotification(message, type = 'error') {
            notification.textContent = message;
            notification.className = '';
            notification.classList.add(type, 'show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function setButtonsDisabled(disabled) {
            generateBtn.disabled = disabled;
            improveBtn.disabled = disabled;
            docsBtn.disabled = disabled;
        }

        // --- Core Gemini API call function ---
        async function callGemini(systemPrompt, userCode, loaderMessage = 'Thinking...') {
            const userApiKey = apiKeyInput.value.trim();
            if (!userApiKey) {
                showNotification('Please enter your Gemini API key.');
                apiKeyInput.focus();
                return null;
            }
             if (!userCode.trim()) {
                showNotification('Please upload or paste some code first.');
                return null;
            }

            loaderText.textContent = loaderMessage;
            loader.classList.remove('hidden');
            setButtonsDisabled(true);

            const modelName = modelSelect.value;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${userApiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userCode }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API call failed: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
                }
                
                const result = await response.json();
                return result;

            } catch (error) {
                console.error('Error:', error);
                showNotification(`An error occurred: ${error.message}`);
                return null;
            } finally {
                loader.classList.add('hidden');
                setButtonsDisabled(false);
            }
        }

        // --- Feature 1: Explain Code ---
        generateBtn.addEventListener('click', async () => {
            const userCode = codeInput.value;
            const systemPrompt = `You are an expert programmer and technical writer. Your task is to receive a piece of code and provide a high-quality, segmented explanation for it, adhering to the following strict rules:
- **GRANULARITY & GROUPING:** Your goal is to find a balance. Group code into semantically meaningful segments. For procedural code, break it down into smaller, related steps. For structured code, a segment is an entire function, class, or full CSS rule.
- **NO TRIVIAL SEGMENTS (CRITICAL):** You are STRICTLY FORBIDDEN from creating segments for code that has no explanatory value on its own (e.g., single closing braces, blank lines). These MUST be bundled with the preceding major logical code block. Comments should be grouped with the code they describe.
- **PERFECT RECONSTRUCTION:** The 'code' from all segments, when concatenated, MUST perfectly match the original input.
- **NO EMPTY SEGMENTS:** Both 'code' and 'explanation' properties MUST NOT be empty.
- **OUTPUT FORMAT:** You MUST respond with a JSON object with a single key 'segments', which is an array of objects. Each object must have two keys: 'code' (string) and 'explanation' (Markdown string).`;
            
            const payload = {
                contents: [{ parts: [{ text: userCode }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "OBJECT", properties: { "segments": { type: "ARRAY", items: { type: "OBJECT", properties: { "code": { "type": "STRING" }, "explanation": { "type": "STRING" } }, required: ["code", "explanation"] } } } }
                }
            };
            
            // This feature has a custom payload, so we don't use the generic callGemini function
            const userApiKey = apiKeyInput.value.trim();
            if (!userApiKey || !userCode.trim()) { 
                showNotification(!userApiKey ? 'Please enter your Gemini API key.' : 'Please upload or paste some code first.');
                return;
            }

            loaderText.textContent = 'Analyzing code and generating segments...';
            loader.classList.remove('hidden');
            placeholder.style.display = 'none';
            explanationContent.innerHTML = '';
            setButtonsDisabled(true);

            const modelName = modelSelect.value;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${userApiKey}`;
            
            try {
                 const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 if (!response.ok) {
                    const errorBody = await response.json(); console.error("API Error Response:", errorBody);
                    throw new Error(`API call failed: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                const jsonText = candidate?.content?.parts?.[0]?.text;
                if (jsonText) {
                    const parsedJson = JSON.parse(jsonText);
                    displayExplanation(parsedJson.segments);
                } else {
                    placeholder.style.display = 'block';
                    showNotification("Failed to generate explanation. The model's response was empty or invalid.");
                }
            } catch(error) {
                console.error('Error:', error);
                showNotification(`An error occurred: ${error.message}`);
                placeholder.style.display = 'block';
            } finally {
                loader.classList.add('hidden');
                setButtonsDisabled(false);
            }
        });
        
        function displayExplanation(segments) {
             explanationContent.innerHTML = '';
            if (!segments || segments.length === 0) { placeholder.style.display = 'block'; return; }
            segments.forEach(segment => {
                if (!segment.code || !segment.explanation || !segment.code.trim() || !segment.explanation.trim()) { return; }
                const row = document.createElement('div');
                row.className = 'segment-row grid grid-cols-1 md:grid-cols-2 gap-0';
                const safeCode = segment.code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                const explanationHtml = formatExplanationMarkdown(segment.explanation);
                row.innerHTML = `<div class="explanation-segment">${explanationHtml}</div><div class="code-segment"><pre><code>${safeCode}</code></pre></div>`;
                explanationContent.appendChild(row);
            });
            if (typeof renderMathInElement === 'function') {
                renderMathInElement(explanationContent, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false} ] });
            }
        }

        // --- Feature 2: Suggest Improvements ---
        improveBtn.addEventListener('click', async () => {
            const systemPrompt = `You are an expert senior software engineer and a world-class code reviewer. Analyze the following code and provide clear, actionable suggestions for improvement. Focus on readability, performance, best practices, potential bugs, and security vulnerabilities. Provide your feedback in a well-structured Markdown format, using headings for categories and code snippets for illustration.`;
            const result = await callGemini(systemPrompt, codeInput.value, 'Generating improvement suggestions...');
            if (result) {
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                showModal('Code Improvement Suggestions', text);
            }
        });

        // --- Feature 3: Add Documentation ---
        docsBtn.addEventListener('click', async () => {
            const systemPrompt = `You are an expert programmer who writes excellent documentation. Analyze the following code, automatically detect its language, and add comprehensive docstrings/comments in the standard format for that language (e.g., JSDoc, Python docstrings). Your output must be a single Markdown code block containing the complete, updated code.`;
            const result = await callGemini(systemPrompt, codeInput.value, 'Generating documentation...');
            if (result) {
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                showModal('Generated Documentation', text);
            }
        });
        
        // --- Modal Logic ---
        function showModal(title, markdownContent) {
            modalTitle.textContent = title;
            if (markdownContent) {
                modalContentArea.innerHTML = formatExplanationMarkdown(markdownContent);
            } else {
                 modalContentArea.innerHTML = '<p class="text-gray-400">No content was generated. The model may have found no suggestions or returned an empty response.</p>';
            }
            modalOverlay.classList.remove('hidden');
        }

        function closeModal() {
            modalOverlay.classList.add('hidden');
        }

        modalCloseBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        // --- General Markdown Formatting ---
        function formatExplanationMarkdown(markdown) {
            let html = markdown
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/```[\s\S]*?```/g, (match) => { // Handle code blocks first
                    const code = match.replace(/```(\w+)?\n?([\s\S]+)```/, '$2');
                    const safeCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    return `<pre><code>${safeCode}</code></pre>`;
                });
                
            const formatInline = (text) => text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>');
            
            return html.trim().split(/\n{2,}/).map(block => {
                if (block.startsWith('<h') || block.startsWith('<pre>')) return block;
                block = block.trim();
                if (block.split('\n').every(line => line.trim().startsWith('- ') || line.trim().startsWith('* '))) {
                    const listItems = block.split('\n').map(item => `<li>${formatInline(item.trim().substring(2))}</li>`).join('');
                    return `<ul class="list-disc list-inside">${listItems}</ul>`;
                }
                return `<p>${formatInline(block).replace(/\n/g, '<br>')}</p>`;
            }).join('');
        }
    </script>
</body>
</html>


